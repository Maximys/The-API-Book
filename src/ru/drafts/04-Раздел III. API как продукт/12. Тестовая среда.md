### Тестовая среда

Отдельно стоит обсудить предоставление разработчику возможности протестировать полный цикл работы API автоматически. Во многих предметных областях сделать это отнюдь не просто — в частности, и в нашем выдуманном примере с API кофе-машин. В реальной жизни полный happy path заказа, от запроса пользователем информации о доступных предложениях до выставления обратной связи по завершению занимает минуты, иногда десятки минут. Чтобы протестировать какие-то крайние случаи (например, запрос пользователем возврата денежных средств из-за проблем с качеством заказа) требует совершения нескольких десятков последовательных шагов. Ситуация осложняется также тем, что сценарии, связанные с деньгами прямо или косвенно (например, в виде отправки SMS) тестировать «в лоб» накладно. Для облегчения работы с такими API необходима полноценная тестовая среда, с помощью которой разработчики будут обкатывать свой код.

#### Полная симуляция

Очевидное решение — это предоставить специальные сборки SDK или тестовые приложения, с помощью которых разработчик сможет выполнить все необходимые действия. Последовательность шагов при этом ничем не отличается от реального цикла работы: разработчик запускает приложение, создаёт заказы и выполняет прочие действия так, как это делает реальный конечный пользователь системы.

Проблему платежей при этом обычно решают предоставлением специальных тестовых SDK же, где не требуется вводить реальных данных кредитных карт и номеров телефонов, и оплачиваемые действия каким-то образом эмулируются.

Достоинством этого подхода является максимальная приближенность к реальному миру. Недостаток всё тот же: для проверки каждого сценария необходимо вручную (или полуавтоматически с помощью фреймворков типа Selenium) выполнить множество разнообразных действий.

#### API среды тестирования

Исправить ситуацию помогает метапрограммирование: если предоставить API к самой тестовой среде, все эти действия по работе с приложением можно автоматизировать и тем самым существенно ускорить и упростить. Вместо того, чтобы открывать приложение и вручную создавать заказ, разработчик вызывает специальные методы API, которые эмулируют действия пользователя. Это могут быть как реально существующие методы (т.е. по сути внутренний API приложения), так и синтетические функции, разработанные специально для тестирования. Для работы с таким API часто целесообразно предоставлять отдельный SDK или библиотеку готовых вызовов типа коллекции для Postman.

Следует отметить, что API среды тестирования существенно сокращает количество ручной работы, но не время, затраченное на прогон одного сценария: в идеале работа с таким API должна происходить в таком же масштабе времени, что и работа реального приложения, иначе велик шанс пропустить какие-то ошибки, связанные с плохо настроенными интервалами ожидания ответа на запрос, а также увеличивается вероятность false negative ошибок при тестировании, связанных с тем, что реальный код всё-таки работает не мгновенно, а требует определённого (и не всегда предсказуемого) времени для исполнения.

#### Предопределённые сценарии

Альтернативой API среды является эмуляция сценариев работы, когда тестовая среда берёт на себя управление недоступными разработчику действиями. В нашем кофейном примере это будет выглядеть так: после размещения заказа система автоматически эмулирует все шаги его приготовления, а потом и получение заказа конечным пользователем — как правило, в ускоренном масштабе времени. Плюсом такого подхода является наглядная демонстрация, каким образом система работает согласно задумке провайдера API, какие события в какой последовательности генерируются. Основным минусом является необходимость предусмотреть в такой песочнице все возможные unhappy path, т.е. возникающие ошибки, причём также необходимо и предоставить возможность разработчику указать, какой именно из сценариев он хочет воспроизвести. Например, если заказ создан с комментарием определённого вида, будет эмулирована ошибка его исполнения, и разработчик сможет отладить правильную реакцию на такого рода ошибку.
